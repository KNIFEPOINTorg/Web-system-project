<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - LFLshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/auth-styles.css">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <div class="expand-icon">+</div>
                <div class="logo">
                    <img src="../Logo/LOCALS.png" alt="LFLshop Logo">
                </div>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="explore.html">Explore</a></li>
                <li><a href="sale.html">Sale</a></li>
            </ul>
            <div class="nav-right">
                <div class="search-container">
                    <input type="text" placeholder="Search" class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="nav-icons">
                    <a href="#" class="nav-icon cart-icon"><i class="fas fa-shopping-cart"></i></a>
                    <div class="auth-links">
                        <a href="signin.html">Sign In</a>
                        <span class="auth-divider">|</span>
                        <a href="signup.html">Sign Up</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Authentication Container -->
    <div class="auth-container">
        <div class="auth-wrapper signin-wrapper">
            <!-- Left Side - Branding -->
            <div class="auth-branding">
                <div class="branding-content">
                    <h1>Create New Password</h1>
                    <p>Your new password must be different from your previous password and meet our security requirements.</p>
                    <div class="features-list">
                        <div class="feature-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secure password requirements</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-lock"></i>
                            <span>Password encryption</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Account security maintained</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-user-shield"></i>
                            <span>Identity verification</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Reset Password Form -->
            <div class="auth-form-container">
                <div class="auth-form signin-form">
                    <div class="form-header">
                        <h2>Reset Your Password</h2>
                        <p id="user-info">Enter your new password below</p>
                    </div>

                    <!-- Reset Password Form -->
                    <form id="reset-password-form" class="login-form">
                        <!-- New Password Input -->
                        <div class="form-group">
                            <label for="newPassword">New Password *</label>
                            <div class="input-container">
                                <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span class="error-message" id="newPassword-error"></span>
                            
                            <!-- Password Strength Indicator -->
                            <div class="password-strength" id="password-strength" style="display: none;">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strength-fill"></div>
                                </div>
                                <span class="strength-text" id="strength-text">Password strength: Very weak</span>
                            </div>
                        </div>

                        <!-- Confirm Password Input -->
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password *</label>
                            <div class="input-container">
                                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span class="error-message" id="confirmPassword-error"></span>
                        </div>

                        <!-- Password Requirements -->
                        <div class="password-requirements">
                            <h4>Password Requirements:</h4>
                            <ul>
                                <li id="req-length" class="requirement">At least 8 characters</li>
                                <li id="req-uppercase" class="requirement">One uppercase letter</li>
                                <li id="req-lowercase" class="requirement">One lowercase letter</li>
                                <li id="req-number" class="requirement">One number</li>
                                <li id="req-special" class="requirement">One special character</li>
                            </ul>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="submit-btn" id="reset-btn">
                            <span class="btn-text">Reset Password</span>
                            <span class="btn-loader" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Resetting...
                            </span>
                        </button>

                        <!-- Back to Sign In -->
                        <div class="form-footer">
                            <p>Remember your password? <a href="signin.html" class="link">Sign In</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Notifications -->
    <div id="notification" class="notification" style="display: none;">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-message"></span>
            <button class="notification-close">&times;</button>
        </div>
    </div>

    <style>
        .password-strength {
            margin-top: 8px;
        }

        .strength-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .strength-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-text {
            font-size: 12px;
            color: #666;
        }

        .password-requirements {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .password-requirements h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
        }

        .password-requirements ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .requirement {
            font-size: 12px;
            color: #666;
            margin: 4px 0;
            position: relative;
            padding-left: 20px;
        }

        .requirement::before {
            content: '✗';
            position: absolute;
            left: 0;
            color: #dc3545;
        }

        .requirement.valid::before {
            content: '✓';
            color: #28a745;
        }

        .password-toggle {
            background: none;
            border: none;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
        }

        .input-container {
            position: relative;
        }
    </style>

    <script>
        let resetToken = null;

        // Get token from URL and verify it
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            resetToken = urlParams.get('token');

            if (!resetToken) {
                showNotification('Invalid reset link. Please request a new password reset.', 'error');
                setTimeout(() => {
                    window.location.href = 'forgot-password.html';
                }, 3000);
                return;
            }

            verifyToken();
            setupPasswordValidation();
            setupForm();
        });

        async function verifyToken() {
            try {
                const response = await fetch(`../api/password_reset.php?action=verify_token&token=${resetToken}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('user-info').textContent = 
                        `Hello ${data.user.name}, enter your new password below`;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showNotification('Invalid or expired reset link. Please request a new password reset.', 'error');
                setTimeout(() => {
                    window.location.href = 'forgot-password.html';
                }, 3000);
            }
        }

        function setupPasswordValidation() {
            const passwordInput = document.getElementById('newPassword');
            const strengthIndicator = document.getElementById('password-strength');
            const strengthFill = document.getElementById('strength-fill');
            const strengthText = document.getElementById('strength-text');

            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                if (password.length > 0) {
                    strengthIndicator.style.display = 'block';
                    
                    // Check requirements
                    const requirements = {
                        length: password.length >= 8,
                        uppercase: /[A-Z]/.test(password),
                        lowercase: /[a-z]/.test(password),
                        number: /\d/.test(password),
                        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                    };

                    // Update requirement indicators
                    Object.keys(requirements).forEach(req => {
                        const element = document.getElementById(`req-${req}`);
                        if (requirements[req]) {
                            element.classList.add('valid');
                        } else {
                            element.classList.remove('valid');
                        }
                    });

                    // Calculate strength
                    const validCount = Object.values(requirements).filter(Boolean).length;
                    const strength = validCount / 5;
                    
                    // Update strength bar
                    strengthFill.style.width = `${strength * 100}%`;
                    
                    if (strength < 0.4) {
                        strengthFill.style.background = '#dc3545';
                        strengthText.textContent = 'Password strength: Very weak';
                    } else if (strength < 0.6) {
                        strengthFill.style.background = '#ffc107';
                        strengthText.textContent = 'Password strength: Weak';
                    } else if (strength < 0.8) {
                        strengthFill.style.background = '#fd7e14';
                        strengthText.textContent = 'Password strength: Good';
                    } else if (strength < 1) {
                        strengthFill.style.background = '#20c997';
                        strengthText.textContent = 'Password strength: Strong';
                    } else {
                        strengthFill.style.background = '#28a745';
                        strengthText.textContent = 'Password strength: Very strong';
                    }
                } else {
                    strengthIndicator.style.display = 'none';
                }
            });
        }

        function setupForm() {
            const form = document.getElementById('reset-password-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                
                // Validate passwords
                if (newPassword.length < 8) {
                    document.getElementById('newPassword-error').textContent = 'Password must be at least 8 characters long';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    document.getElementById('confirmPassword-error').textContent = 'Passwords do not match';
                    return;
                }
                
                // Check password requirements
                const requirements = {
                    uppercase: /[A-Z]/.test(newPassword),
                    lowercase: /[a-z]/.test(newPassword),
                    number: /\d/.test(newPassword),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(newPassword)
                };
                
                if (!Object.values(requirements).every(Boolean)) {
                    document.getElementById('newPassword-error').textContent = 'Password must meet all requirements';
                    return;
                }
                
                await submitPasswordReset(newPassword, confirmPassword);
            });
        }

        async function submitPasswordReset(password, confirmPassword) {
            const submitBtn = document.getElementById('reset-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoader.style.display = 'flex';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('../api/password_reset.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'reset_password',
                        token: resetToken,
                        password: password,
                        confirmPassword: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Password reset successfully! Redirecting to sign in...', 'success');
                    setTimeout(() => {
                        window.location.href = 'signin.html';
                    }, 2000);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showNotification(error.message || 'An error occurred. Please try again.', 'error');
            } finally {
                // Reset button state
                btnText.style.display = 'block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('.notification-icon');
            const messageElement = notification.querySelector('.notification-message');
            
            // Set message
            messageElement.textContent = message;
            
            // Set icon based on type
            let iconClass = 'fas fa-info-circle';
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle';
                    break;
            }
            
            icon.className = `notification-icon ${iconClass}`;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Setup notification close
        document.querySelector('.notification-close').addEventListener('click', function() {
            document.getElementById('notification').style.display = 'none';
        });
    </script>
</body>
</html>